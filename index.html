<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµé‡‘çŒäººï¼šé‡‘å¸ä¸è£è€€ V3.5 - çº¯æœ¬åœ°ç¼“å­˜ç‰ˆ</title>
    <style>
        :root {
            --primary: #c0392b; 
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #1a1a2e;
            --card-bg: #1e3a5f;
            --text: #fff;
            --gold: #f39c12; 
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-bottom: 4px solid var(--gold);
        }
        h1 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
        
        /* è§’è‰²/æ§åˆ¶é¢æ¿ */
        .controls {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-gold { background: var(--gold); color: #333; }
        .btn-secondary { background: #34495e; color: white; }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; }
        
        /* è§’è‰²æ ‡ç­¾ */
        #roleTag {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            margin-right: 15px;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸ */
        .game-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
        }

        /* çŒäººåˆ—è¡¨ (æ’åæ¦œ) */
        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .hero-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            border: 2px solid #2a3b55;
            transition: all 0.3s;
        }
        .avatar {
            width: 60px;
            height: 60px;
            background: #333;
            border-radius: 50%;
            border: 3px solid var(--gold);
            overflow: hidden;
        }
        .hero-score { 
            font-size: 24px; 
            font-weight: bold; 
            color: var(--gold); 
            text-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
        }

        /* ç­çº§æ’è¡Œæ¦œæ ·å¼ */
        .class-ranking-section {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .class-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #333;
            cursor: pointer; 
            transition: background 0.2s;
        }
        .class-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .class-entry:last-child { border-bottom: none; }
        .class-name { font-weight: bold; }
        .class-total-score { color: var(--success); font-weight: bold; }

        /* é€šç”¨å¼¹çª—/é®ç½© */
        .modal, .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 99;
        }
        .overlay { background: rgba(0,0,0,0.7); }
        
        .modal-content {
            position: absolute;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            
            background: #222;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 100;
            border: 2px solid var(--primary);
            width: 400px;
            max-width: 90%; 
            max-height: 80vh;
            overflow-y: auto;
        }
        textarea, input[type="number"], input[type="text"], select { 
            width: 100%; 
            padding: 10px;
            margin: 10px 0; 
            background: #333; 
            color: white; 
            border: 1px solid #555; 
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* å•†åº—éšæœºå…‘æ¢æŒ‰é’®æ ·å¼ */
        .btn-random {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: #fff;
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.5);
            margin-top: 10px;
            /* å¼ºè°ƒ Gacha æŒ‰é’® */
            border: 3px solid #ffcc00; 
        }
        
        /* Gacha Result Modal æ ·å¼ */
        .gacha-result {
            text-align: center;
            padding: 20px;
            min-height: 250px; 
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }
        .gacha-drawing {
            font-size: 50px;
            animation: spin 0.5s infinite linear;
            display: inline-block;
            color: var(--gold);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .gacha-reveal {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed var(--gold);
            border-radius: 8px;
            background: rgba(243, 156, 18, 0.1);
        }
        .gacha-item-name {
            font-size: 26px;
            font-weight: bold;
            color: var(--success);
            text-shadow: 0 0 8px rgba(39, 174, 96, 0.7);
        }
        .gacha-item-desc {
            font-size: 14px;
            color: #ccc;
            margin-top: 5px;
        }

        /* Store Card Enhancement */
        .item-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a3b55;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .store-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-open { background: var(--success); color: var(--card-bg); }
        .status-closed { background: var(--danger); color: var(--card-bg); }
        
        /* V3.0 Search Results Styling */
        .search-result-item {
            padding: 10px;
            border-bottom: 1px dashed #555;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
        }
        .search-result-item:hover {
            background: #34495e;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* V3.2 Pinyin Management Styling */
        .pinyin-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #333;
            font-size: 16px;
        }
        .pinyin-char { font-weight: bold; color: var(--gold); }
        .pinyin-initial { color: var(--success); margin-left: 10px; }
        
        /* V3.5: æ¸…é›¶æŒ‰é’®çš„ç‰¹æ®Šæ ·å¼ */
        .btn-clear-score {
            background: #8e44ad; 
            color: white;
        }

    </style>
</head>
<body>
<audio id="exchangeJingle" src="https://assets.mixkit.co/sfx/preview/mixkit-casino-reward-bell-1678.mp3" preload="auto"></audio>

<header>
    <div>
        <h1>ğŸ’° èµé‡‘çŒäººï¼šé‡‘å¸ä¸è£è€€</h1>
        <div style="font-size: 14px; color: #888;">V3.5 - çº¯æœ¬åœ°ç¼“å­˜ç‰ˆ (æ•°æ®ä¸è‡ªåŠ¨åŒæ­¥)</div>
    </div>
    <div class="controls">
        <span id="roleTag" class="role-teacher">æ•™å¸ˆ (ç®¡ç†)</span>
        <select id="roleSelector" onchange="changeRole(this.value)" style="padding: 8px; background: #333; color: white; border: 1px solid #555;">
            </select>
        
        <button id="importBtn" class="btn-primary" onclick="openImport()">ğŸ“‚ å¯¼å…¥èµé‡‘åå•</button>
        <button id="manageStoreBtn" class="btn-secondary" onclick="openStoreManager()">ğŸª ç®¡ç†å•†åº—</button>
        <button id="exportLogBtn" class="btn-secondary" onclick="exportLogData()">ğŸ“œ å¯¼å‡ºæ“ä½œæ—¥å¿—</button>
        <button id="exportCSVBtn" class="btn-success" onclick="exportData()">ğŸ’¾ å¯¼å‡ºæˆ˜æŠ¥ (CSV)</button>
        <button id="clearScoreBtn" class="btn-clear-score" onclick="clearAllScores()">ğŸ…ï¸ æ¸…é›¶æ‰€æœ‰ç§¯åˆ†</button>
    </div>
</header>

<div class="game-container">
    <div class="main-view">
        <h2 style="margin:0 0 15px 0">ğŸ¥‡ å…¬ä¼šä¸çŒäººæ’å</h2>

        <div class="class-ranking-section">
            <h4 style="margin-top:0;">ğŸ† ç­çº§å…¬ä¼šé‡‘å¸æ€»æ¦œ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</h4>
            <div id="classLeaderboard">
                </div>
        </div>
        
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin:0;">ğŸ‘¤ çŒäººåˆ—è¡¨</h4>
            <div>
                <select id="classFilter" onchange="changeClassFilter(this.value)" style="padding: 8px; background: #333; color: white; border: 1px solid #555; margin-right: 10px;">
                    <option value="all">æ˜¾ç¤ºæ‰€æœ‰çŒäºº (All)</option>
                    </select>
                <button id="searchAdjustBtn" class="btn-secondary" onclick="openSearchAdjustModal()" style="display: none;">ğŸ” æœç´¢å­¦ç”Ÿè°ƒæ•´</button>
            </div>
        </div>
        
        <div class="hero-grid" id="heroGrid">
            </div>
    </div>

    <div class="store-view">
        <div class="store-panel">
            <div class="store-header">
                <h3 style="margin:0">ğŸ›’ å…‘æ¢å•†åº—</h3>
                <span id="storeStatusBadge" class="store-status status-closed">ä¼‘æ¯ä¸­</span>
            </div>
            
            <button id="toggleStoreBtn" class="btn-primary" style="width: 100%; margin-bottom: 20px;" onclick="toggleStore()">
                ğŸ”“ å¼€å¯å…‘æ¢
            </button>
            
            <button id="randomExchangeBtn" class="btn-random" style="width: 100%; margin-bottom: 20px; display: none;" onclick="openExchangeSelector(null, true)">
                ğŸ° éšæœºæ‰­æ‰­ä¹ (40.0 ğŸ’°)
            </button>

            <div id="storeItemsContainer" class="item-list" style="opacity: 0.5; pointer-events: none;">
                </div>
            
            <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">
                <h4>ğŸ“œ æ“ä½œ/å…‘æ¢æ—¥å¿— (æœ€æ–°)</h4>
                <div id="logArea" style="height: 150px; overflow-y: auto; font-size: 12px; color: #aaa;">
                    æš‚æ— è®°å½•...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="importOverlay"></div>
<div class="modal" id="importModal">
    <div class="modal-content">
        <h3>å¯¼å…¥èµé‡‘çŒäººåå• (Excel ç²˜è´´)</h3>
        <p>è¯·ç›´æ¥ä» Excel æˆ–è¡¨æ ¼è½¯ä»¶ä¸­å¤åˆ¶ä¸‰åˆ—æ•°æ®ç²˜è´´ã€‚**å¦‚æœå­¦ç”Ÿå§“åå·²å­˜åœ¨ï¼Œé‡‘å¸å°†å åŠ **ã€‚</p>
        <p style="color:var(--success); font-weight:bold;">æ‰€éœ€åˆ—é¡ºåºï¼šå§“å | é‡‘å¸å€¼ | ç­çº§å· (ç­çº§å·å¯é€‰å¡«ï¼Œé»˜è®¤'1')</p>
        <textarea id="studentNamesInput" placeholder="å¼ ä¸‰   10.0   1&#10;æå››, 5.5, 2"></textarea>
        <div style="text-align: right;">
            <button class="btn-primary" onclick="closeImport()">å–æ¶ˆ</button>
            <button class="btn-success" onclick="processImport()">ç¡®å®šå¯¼å…¥</button>
        </div>
    </div>
</div>

<div class="overlay" id="exchangeSelectorOverlay"></div>
<div class="modal" id="exchangeSelectorModal">
    <div class="modal-content">
        <h3 id="exchangeTitle">å…‘æ¢å•†å“ï¼š[å•†å“åç§°]</h3>
        <p id="exchangeCostInfo"></p>
        
        <label>é€‰æ‹©ç­çº§:</label>
        <select id="exchangeClassSelector" onchange="populateStudentSelectors()"></select>
        
        <label>é€‰æ‹©å…‘æ¢å­¦ç”Ÿ:</label>
        <select id="exchangeStudentSelector"></select>
        
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn-primary" onclick="closeExchangeSelector()">å–æ¶ˆ</button>
            <button class="btn-success" onclick="confirmExchange()">ç¡®è®¤å…‘æ¢</button>
        </div>
    </div>
</div>

<div class="overlay" id="searchAdjustOverlay"></div>
<div class="modal" id="searchAdjustModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ” æœç´¢å¹¶é€‰æ‹©çŒäºº</h3>
        <input type="text" id="studentSearchInput" placeholder="è¾“å…¥å­¦ç”Ÿå§“åæˆ–é¦–å­—æ¯ï¼ˆä¾‹å¦‚ï¼šZSï¼‰è¿›è¡Œæœç´¢..." oninput="filterStudentsForAdjust(this.value)">
        <p style="font-size: 12px; color: #aaa;" id="searchInstruction">ç‚¹å‡»åˆ—è¡¨ä¸­çš„çŒäººè¿›è¡Œèµé‡‘è°ƒæ•´ã€‚</p>
        <div id="studentSearchResults" style="max-height: 300px; overflow-y: auto; border: 1px solid #444; border-radius: 4px; padding: 5px; background: #1a1a2e;">
            <p style="color:#aaa; text-align:center; padding:10px;">å¼€å§‹è¾“å…¥å§“åæˆ–é¦–å­—æ¯...</p>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn-primary" onclick="closeSearchAdjustModal()">å…³é—­</button>
        </div>
    </div>
</div>

<div class="overlay" id="gachaResultOverlay"></div>
<div class="modal" id="gachaResultModal">
    <div class="modal-content">
        <div class="gacha-result">
            <h3 id="gachaResultTitle"></h3>
            <div id="gachaAnimation" class="gacha-drawing">ğŸ”„</div>
            <div id="gachaRevealArea" style="display:none;">
                <p style="color: var(--gold); font-size: 18px;">æ­å–œæ‚¨æŠ½åˆ°ï¼š</p>
                <div class="gacha-reveal">
                    <div class="gacha-item-name" id="gachaItemName"></div>
                    <div class="gacha-item-desc" id="gachaItemDesc"></div>
                </div>
            </div>
            <button class="btn-primary" onclick="closeGachaResultModal()" style="margin-top: 30px; display:none;" id="gachaCloseBtn">å…³é—­</button>
        </div>
    </div>
</div>

<div class="overlay" id="adjustOverlay"></div>
<div class="modal" id="adjustModal">
    <div class="modal-content">
        <h3 id="adjustTitle">è°ƒæ•´èµé‡‘ï¼š[çŒäººå§“å]</h3>
        <p>è¾“å…¥è¦è°ƒæ•´çš„é‡‘å¸å€¼ï¼ˆæ­£æ•°åŠ é‡‘å¸ï¼Œè´Ÿæ•°æ‰£é‡‘å¸ï¼Œæ”¯æŒ $0.5$ å€æ•°ï¼‰ã€‚</p>
        <input type="number" id="adjustAmount" placeholder="ä¾‹å¦‚: 5.0 æˆ– -2.5" step="0.5">
        <input type="text" id="adjustReason" placeholder="æ“ä½œåŸå›  (å¿…å¡«)">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <button class="btn-danger" id="deleteStudentBtn" onclick="deleteStudent(adjustingStudentId)">âŒ åˆ é™¤å­¦ç”Ÿ</button>
            <div>
                <button class="btn-primary" onclick="closeAdjustModal()">å–æ¶ˆ</button>
                <button class="btn-success" onclick="submitAdjust()">ç¡®è®¤æ“ä½œ</button>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="storeManagerOverlay"></div>
<div class="modal" id="storeManagerModal">
    <div class="modal-content">
        <h3>ğŸª ç®¡ç†å…‘æ¢å•†åº—å•†å“</h3>
        
        <button class="btn-secondary" onclick="openPinyinManager()" style="width:100%; margin-bottom: 20px;">ğŸ”  ç®¡ç†æ‹¼éŸ³é¦–å­—æ¯æ˜ å°„</button>

        <h4>æ·»åŠ æ–°å¸¸è§„å•†å“</h4>
        <input type="text" id="newItemName" placeholder="å•†å“åç§°">
        <input type="number" id="newItemCost" placeholder="æ‰€éœ€é‡‘å¸æ•° (æ”¯æŒ0.5)" step="0.5">
        <input type="text" id="newItemDesc" placeholder="å•†å“æè¿° (ä¾‹å¦‚: å…é™¤ä¸€æ¬¡ä½œä¸š)">
        <button class="btn-success" onclick="addItemToStore()" style="width:100%; margin-bottom: 20px;">+ æ·»åŠ å¸¸è§„å•†å“</button>

        <h4>ç°æœ‰å¸¸è§„å•†å“åˆ—è¡¨ (ç‚¹å‡»åˆ é™¤)</h4>
        <div id="currentStoreList">
            </div>
        
        <h4 style="margin-top: 30px;">ğŸ° ç®¡ç†æ‰­è›‹ä¸“å±å¥–å“</h4>
        <input type="text" id="newGachaName" placeholder="æ‰­è›‹å¥–å“åç§°">
        <input type="text" id="newGachaDesc" placeholder="å¥–å“æè¿° (ä¾‹å¦‚: é¢å¤–ä¼‘æ¯ 5 åˆ†é’Ÿ)">
        <button class="btn-primary" onclick="addItemToGachaPool()" style="width:100%; margin-bottom: 20px;">+ æ·»åŠ æ‰­è›‹å¥–å“</button>

        <h4>ç°æœ‰æ‰­è›‹å¥–å“åˆ—è¡¨ (ç‚¹å‡»åˆ é™¤)</h4>
        <div id="currentGachaList">
            </div>

        <div style="text-align: right; margin-top: 30px;">
            <button class="btn-primary" onclick="closeStoreManager()">å…³é—­</button>
        </div>
    </div>
</div>

<div class="overlay" id="classDetailOverlay"></div>
<div class="modal" id="classDetailModal">
    <div class="modal-content" id="classDetailContent">
        </div>
</div>

<div class="overlay" id="pinyinManagerOverlay"></div>
<div class="modal" id="pinyinManagerModal">
    <div class="modal-content">
        <h3>ğŸ”  ç®¡ç†æ‹¼éŸ³é¦–å­—æ¯æ˜ å°„</h3>
        <p style="font-size: 12px; color: #aaa;">å½“æ‚¨æœç´¢å­¦ç”Ÿé¦–å­—æ¯å¤±è´¥æ—¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ–°çš„æ±‰å­—æ˜ å°„ï¼Œä¾‹å¦‚ï¼šæ±‰å­— **æ¬§** å¯¹åº”é¦–å­—æ¯ **O**ã€‚</p>
        
        <div style="display:flex; gap: 10px; align-items: center;">
            <input type="text" id="newPinyinChar" placeholder="æ±‰å­— (ä¾‹å¦‚: æ¬§)" maxlength="1" style="width: 50%;">
            <input type="text" id="newPinyinInitial" placeholder="é¦–å­—æ¯ (ä¾‹å¦‚: O)" maxlength="1" style="width: 50%; text-transform: uppercase;">
        </div>
        <button class="btn-success" onclick="addPinyinMapping()" style="width:100%; margin-bottom: 20px;">+ æ·»åŠ æ–°æ˜ å°„</button>

        <h4>ç°æœ‰æ˜ å°„åˆ—è¡¨ (ç‚¹å‡»åˆ é™¤)</h4>
        <div id="currentPinyinList" style="max-height: 250px; overflow-y: auto; border: 1px solid #444; border-radius: 4px; padding: 5px;">
            </div>
        
        <div style="text-align: right; margin-top: 30px;">
            <button class="btn-primary" onclick="closePinyinManager()">å…³é—­</button>
        </div>
    </div>
</div>


<script>
    // --- 1. æ ¸å¿ƒæ•°æ®ä¸çŠ¶æ€ & Pinyin è¾…åŠ©æ˜ å°„ ---
    
    // V3.5: æœ¬åœ°ç¼“å­˜é”®å
    const LOCAL_STORAGE_KEY = 'bountyHunterData_v35'; 

    // --- ã€STARTã€‘é»˜è®¤å­¦ç”Ÿåå• (é›†æˆæ‚¨çš„æ•°æ®) ---
    
    // **æ³¨æ„ï¼š** ä»…å½“æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨ä»¥ä¸‹é»˜è®¤åå•ã€‚
    // å¦‚æœæ‚¨ä¹‹å‰åœ¨æµè§ˆå™¨ä¸­è¿è¡Œè¿‡æ—§ç‰ˆæœ¬ï¼Œè¯·æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ (Ctrl+Shift+Del æˆ– Command+Shift+Del) ä»¥ç¡®ä¿åŠ è½½è¿™å¥—æ–°åå•ã€‚
    const defaultStudents = [
        // ç­çº§ 1 
        { id: Date.now() + 1, name: "ä¸‡å­æ™¨", score: 58, class: "1" },
        { id: Date.now() + 2, name: "æ˜Œå–„å¯’", score: 16.25, class: "1" },
        { id: Date.now() + 3, name: "ç‹é›¨æ³½", score: 17.5, class: "1" },
        { id: Date.now() + 4, name: "æ–¹åš", score: 48, class: "1" },
        { id: Date.now() + 5, name: "è‰¾å¤©å®‡", score: 61, class: "1" },
        { id: Date.now() + 6, name: "æè¯­æ™¨", score: 39.5, class: "1" },
        { id: Date.now() + 7, name: "ç‹é›¯æœˆ", score: 28.25, class: "1" },
        { id: Date.now() + 8, name: "ææ€¡", score: 81.5, class: "1" },
        { id: Date.now() + 9, name: "æå­è½©", score: 22, class: "1" },
        { id: Date.now() + 10, name: "å´æ³‰ä¹", score: -5.25, class: "1" },
        { id: Date.now() + 11, name: "å­™ä¹‰å†‰", score: 42.5, class: "1" },
        { id: Date.now() + 12, name: "ä¸‡å®‡ç•…", score: 45.75, class: "1" },
        { id: Date.now() + 13, name: "ç¥å¿—è´¤", score: 50.5, class: "1" },
        { id: Date.now() + 14, name: "ä½™æ¬£ç„¶", score: 90.5, class: "1" },
        { id: Date.now() + 15, name: "é™ˆå®‰çª", score: 51, class: "1" },
        { id: Date.now() + 16, name: "éƒ­ä½³ç››", score: 24, class: "1" },
        { id: Date.now() + 17, name: "æœ±æ˜Œåš", score: 60, class: "1" },
        { id: Date.now() + 18, name: "æ¨å³»ç†™", score: 21.5, class: "1" },
        { id: Date.now() + 19, name: "åˆ˜å‡¯è½©", score: 12.75, class: "1" },
        { id: Date.now() + 20, name: "ä¸‡æ¢“è¾‰", score: 5.75, class: "1" },
        { id: Date.now() + 21, name: "å¾é”¦è½©", score: 29.5, class: "1" },
        { id: Date.now() + 22, name: "ç¥ä¸–æ°", score: 9.5, class: "1" },
        { id: Date.now() + 23, name: "é­æ–¯åº†", score: 4, class: "1" },
        { id: Date.now() + 24, name: "èƒ¡ç‚çš", score: 44.5, class: "1" },
        { id: Date.now() + 25, name: "æˆˆå…´æ—º", score: 27, class: "1" },
        { id: Date.now() + 26, name: "å´é½æ‚¦", score: 16.25, class: "1" },
        { id: Date.now() + 27, name: "ç†Šå­è¶Š", score: 19, class: "1" },
        { id: Date.now() + 28, name: "é’ŸæŒ¯å", score: 33.5, class: "1" },
        { id: Date.now() + 29, name: "å´æ¢¦æ¶µ", score: 19.5, class: "1" },
        { id: Date.now() + 30, name: "å´é’°çŠ", score: 52, class: "1" },
        { id: Date.now() + 31, name: "é™ˆé›¨è½©", score: 42.25, class: "1" },
        { id: Date.now() + 32, name: "éƒå‹‡æ³¢", score: 26, class: "1" },
        { id: Date.now() + 33, name: "æ¸¸çš“å®‡", score: 43, class: "1" },
        
        // ç­çº§ 3 
        { id: Date.now() + 34, name: "èƒ¡å½¦æ³½", score: 5.5, class: "3" },
        { id: Date.now() + 35, name: "æ®·èˆ’é›…", score: 56.25, class: "3" },
        { id: Date.now() + 36, name: "æ¢å®‡è½©", score: 10.25, class: "3" },
        { id: Date.now() + 37, name: "ç‹ç¥å©·", score: 46, class: "3" },
        { id: Date.now() + 38, name: "æˆˆæ”€æ–°", score: 25, class: "3" },
        { id: Date.now() + 39, name: "æ¨å®é‘«", score: 14, class: "3" },
        { id: Date.now() + 40, name: "ç†Šå®‡æµ©", score: 14, class: "3" },
        { id: Date.now() + 41, name: "å¼ å¤©ä½‘", score: -8, class: "3" },
        { id: Date.now() + 42, name: "é¾šæ·‘é›…", score: 2.75, class: "3" },
        { id: Date.now() + 43, name: "æé›¨æ¬£", score: 99.5, class: "3" },
        { id: Date.now() + 44, name: "å¼ å­å¢¨", score: 71, class: "3" },
        { id: Date.now() + 45, name: "ä½™ç´«æ¶µ", score: 93.5, class: "3" },
        { id: Date.now() + 46, name: "è°¢ç”³åš", score: 22.5, class: "3" },
        { id: Date.now() + 47, name: "éƒ‘èŒ—ç‚œ", score: 35, class: "3" },
        { id: Date.now() + 48, name: "äº§åšæ¶›", score: -1.25, class: "3" },
        { id: Date.now() + 49, name: "å­™å›½å·", score: 55.75, class: "3" },
        { id: Date.now() + 50, name: "ç”°å…´åš", score: 44.5, class: "3" },
        { id: Date.now() + 51, name: "è‰¾æ¬£ç…œ", score: 30.5, class: "3" },
        { id: Date.now() + 52, name: "é‚¹æ§¿çƒ¨", score: 7, class: "3" },
        { id: Date.now() + 53, name: "ç”°è‰ºå®", score: 48.5, class: "3" },
        { id: Date.now() + 54, name: "é›·æ¢“æ‚¦", score: 121, class: "3" },
        { id: Date.now() + 55, name: "ä½•å®‡è½©", score: 12.25, class: "3" },
        { id: Date.now() + 56, name: "æœ±éœ–", score: 27.5, class: "3" },
        { id: Date.now() + 57, name: "èµµå®ˆä¿¡", score: 7.5, class: "3" },
        { id: Date.now() + 58, name: "èƒ¡å°”åš", score: 29.75, class: "3" },
        { id: Date.now() + 59, name: "å‘¨é½æœ”", score: 38, class: "3" },
        { id: Date.now() + 60, name: "ç†ŠèŠ®æ™—", score: 53, class: "3" },
        { id: Date.now() + 61, name: "æ¨å­ä¼˜", score: 38, class: "3" },
        { id: Date.now() + 62, name: "ä¸å¿—è±ª", score: 29.5, class: "3" },
        { id: Date.now() + 63, name: "æ–¹å¤«é‘«", score: 56.25, class: "3" },
        { id: Date.now() + 64, name: "ä½•åŠ²", score: 31.75, class: "3" },
        { id: Date.now() + 65, name: "å‘¨æ“æ˜Š", score: 25.5, class: "3" },
        { id: Date.now() + 66, name: "ç”˜æ€åš", score: 51.75, class: "3" },
        { id: Date.now() + 67, name: "èƒ¡å®‡æ™´", score: 38, class: "3" },
        { id: Date.now() + 68, name: "æœæ–‡åš", score: 15.25, class: "3" },
        { id: Date.now() + 69, name: "ä½™æ¢“å½¤", score: 54, class: "3" },
        { id: Date.now() + 70, name: "åˆ˜ä¸€å¸†", score: -1, class: "3" },
        { id: Date.now() + 71, name: "å¼ å¥½å¥½", score: 33, class: "3" },
        { id: Date.now() + 72, name: "æèŠ®è¡", score: 33, class: "3" },
        { id: Date.now() + 73, name: "å»–æ¶µè‰º", score: 29.5, class: "3" },
        { id: Date.now() + 74, name: "å¾æ¢¦å¦®", score: 56, class: "3" },
        { id: Date.now() + 75, name: "é™ˆå•¸", score: 49, class: "3" },
        { id: Date.now() + 76, name: "å´ç¿", score: 63, class: "3" },
        { id: Date.now() + 77, name: "ä½™é›ª", score: 80, class: "3" },
        { id: Date.now() + 78, name: "åˆ˜èŒœ", score: 44, class: "3" },
        { id: Date.now() + 79, name: "ä½•å®‡å¥", score: -18.5, class: "3" },
        { id: Date.now() + 80, name: "å´æŒ¯é›„", score: 34, class: "3" },
        { id: Date.now() + 81, name: "æ´ªä¼Ÿ", score: 15.5, class: "3" },
        { id: Date.now() + 82, name: "ç”°å­æ¶µ", score: 4, class: "3" },
        { id: Date.now() + 83, name: "åºç¿æ˜Š", score: 29.5, class: "3" }
    ];
    let students = [...defaultStudents];
    
    // --- ã€ENDã€‘é»˜è®¤å­¦ç”Ÿåå• ---

    // é»˜è®¤å•†åº—æ•°æ®
    // **å·²æ ¹æ®æ‚¨çš„è¦æ±‚æ›´æ–°**
    let storeItems = [
        { id: 101, name: "å¥¶èŒ¶ 1 æ¯", cost: 70.0, desc: "å…‘æ¢ä¸€æ¯æŒ‡å®šå¥¶èŒ¶" },
        { id: 102, name: "è§£å‹ææä¹", cost: 60.0, desc: "å…‘æ¢ä¸€ä¸ªè§£å‹å°ç©å…·" }
    ];

    // é»˜è®¤æ‰­è›‹å¥–å“
    let gachaPrizes = [
        { id: 201, name: "å…é™¤ç½šæŠ„å¡", desc: "éšæœºå…é™¤ä¸€æ¬¡ç½šæŠ„ä»»åŠ¡" },
        { id: 202, name: "å¹¸è¿å°é¥¼å¹²", desc: "ä¸‹æ¬¡æµ‹è¯•è·å¾—ä¸€æ¬¡è¿æ°”åŠ æˆ" },
        { id: 203, name: "é›¶é£Ÿå…‘æ¢åˆ¸", desc: "å…‘æ¢å°é›¶é£Ÿä¸€ä»½" },
        { id: 204, name: "æ•™å¸ˆå½©è™¹å±", desc: "è·å¾—æ•™å¸ˆçœŸè¯šçš„èµç¾å’Œé¼“åŠ±" }
    ];

    let exchangeLog = []; 
    let isStoreOpen = false;
    let PinyinMap = {
        'å¼ ': 'Z', 'æ': 'L', 'ç‹': 'W', 'èµµ': 'Z', 'é’±': 'Q', 'å­™': 'S',
        'èµ': 'S', 'é‡‘': 'J', 'çŒ': 'L', 'äºº': 'R', 'ä¸‰': 'S', 'å››': 'S',
        'äº”': 'W', 'å…­': 'L', 'ä¸ƒ': 'Q', 'å…«': 'B', 'Â·': '',
        // V3.5 å¢åŠ éƒ¨åˆ†æ–°åå­—çš„æ‹¼éŸ³æ˜ å°„
        'æ˜Œ': 'C', 'é›¯': 'W', 'ç‚': 'K', 'çš': 'Y', 'æˆˆ': 'G', 'æ³½': 'Z', 
        'ç¥': 'Y', 'æ”€': 'P', 'å®‡': 'Y', 'æµ©': 'H', 'é¾š': 'G', 'æ¬£': 'X',
        'å¢¨': 'M', 'ç´«': 'Z', 'ç”³': 'S', 'éƒ‘': 'Z', 'ç‚œ': 'W', 'äº§': 'C',
        'æ¶›': 'T', 'ç…œ': 'Y', 'æ§¿': 'J', 'çƒ¨': 'Y', 'æ™—': 'H', 'å¤«': 'F',
        'åŠ²': 'J', 'æ“': 'Q', 'æ€': 'S', 'æ™´': 'Q', 'å½¤': 'T', 'èŒœ': 'Q',
        'ä¼Ÿ': 'W', 'èŠ®': 'R', 'æ¶µ': 'H', 'è‰º': 'Y', 'å¦®': 'N', 'é›ª': 'X',
        'å¥': 'J', 'å°§': 'Y', 'ç•…': 'C', 'è´¤': 'X', 'æ™–': 'H', 'å³»': 'J'
    }; 

    let currentUserRole = 'teacher'; 
    let currentCadreClass = null; 
    let adjustingStudentId = null; 
    let currentClassFilter = 'all'; 

    let currentExchangeItemId = null; 
    let isRandomExchange = false;     
    
    const RANDOM_COST = 40.0;
    
    // V3.3: è§’è‰²æƒé™æ˜ å°„
    const roleMap = {
        'teacher': { tag: 'æ•™å¸ˆ (ç®¡ç†)', class: 'role-teacher', canOperateScore: true, canAdmin: true },
        'cadre': { tag: 'ç­å¹²éƒ¨ (æ“ä½œ)', class: 'role-cadre', canOperateScore: true, canAdmin: false },
        'student': { tag: 'å­¦ç”Ÿ (æŸ¥çœ‹)', class: 'role-student', canOperateScore: false, canAdmin: false }
    };
    

    // --- 2. æŒä¹…åŒ–é€»è¾‘ (V3.5 çº¯æœ¬åœ°ç¼“å­˜é€»è¾‘) ---
    
    // V3.5: å°†æ•°æ®ä¿å­˜åˆ°æµè§ˆå™¨çš„ localStorage
    function saveData() {
        const dataToSave = {
            students: students,
            storeItems: storeItems,
            gachaPrizes: gachaPrizes,
            exchangeLog: exchangeLog,
            isStoreOpen: isStoreOpen,
            PinyinMap: PinyinMap
        };
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            // addLog('**ç³»ç»Ÿ**ï¼šæ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ã€‚', 'System'); // è¿‡äºé¢‘ç¹ï¼Œå–æ¶ˆæ—¥å¿—
        } catch (e) {
            console.error("ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:", e);
        }
    }

    // V3.5: ä»æµè§ˆå™¨çš„ localStorage åŠ è½½æ•°æ®
    async function loadData() {
        try {
            const dataString = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (dataString) {
                const data = JSON.parse(dataString);
                
                // è¦†ç›–å…¨å±€å˜é‡
                students = data.students || students;
                storeItems = data.storeItems || storeItems;
                gachaPrizes = data.gachaPrizes || gachaPrizes;
                exchangeLog = data.exchangeLog || exchangeLog;
                isStoreOpen = data.isStoreOpen !== undefined ? data.isStoreOpen : false;
                PinyinMap = data.PinyinMap || PinyinMap;
                
                // ç¡®ä¿æ•°å­—æ ¼å¼æ­£ç¡®
                students = students.map(s => ({ 
                    ...s, 
                    score: parseFloat(s.score) 
                }));
                addLog('**ç³»ç»Ÿ**ï¼šæ•°æ®å·²ä»æµè§ˆå™¨æœ¬åœ°ç¼“å­˜æ¢å¤ã€‚', 'System');
                return;
            }
        } catch (e) {
            console.error('åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åå•ã€‚', e);
        }
        
        // å¦‚æœæœ¬åœ°å­˜å‚¨å¤±è´¥æˆ–ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åå•
        students = [...defaultStudents];
        addLog('**ç³»ç»Ÿ**ï¼šæ— æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œå·²ä½¿ç”¨ä»£ç ä¸­çš„é»˜è®¤åå•å’Œå•†åº—é…ç½®ã€‚', 'System');
        saveData(); // ä½¿ç”¨é»˜è®¤åå•åç«‹å³ä¿å­˜ä¸€æ¬¡
    }

    // --- Pinyin è¾…åŠ©å‡½æ•° (ä¿æŒä¸å˜) ---
    function getPinyinInitials(name) {
        let initials = '';
        for (let i = 0; i < name.length; i++) {
            const char = name[i];
            initials += PinyinMap[char] || ''; 
        }
        return initials;
    }

    function recalculateSearchKeys() {
        students = students.map(s => {
            const pinyinInitials = getPinyinInitials(s.name);
            return {
                ...s, 
                pinyinInitials: pinyinInitials,
                searchKey: (s.name + pinyinInitials).toLowerCase()
            };
        });
    }
    
    // --- 3. åˆå§‹åŒ–ä¸æ¸²æŸ“ ---
    async function init() {
        await loadData(); 
        
        recalculateSearchKeys();
        renderRoleSelector(); 
        changeRole('teacher'); 
        toggleStore(false); 
        renderClassFilterOptions();
        renderClassLeaderboard();
        renderHeroes();
        renderStore();
        renderLogHistory();
    }
    
    function getUniqueClasses() {
        const classes = new Set(students.map(s => s.class).filter(c => c));
        return Array.from(classes).sort();
    }
    
    // V3.3: æ¸²æŸ“è§’è‰²é€‰æ‹©å™¨ï¼ŒåŒ…æ‹¬ç­å¹²éƒ¨ç­çº§é€‰é¡¹
    function renderRoleSelector() {
        const select = document.getElementById('roleSelector');
        const uniqueClasses = getUniqueClasses();
        
        let optionsHtml = '<option value="teacher">æ•™å¸ˆ (ç®¡ç†)</option>';
        
        uniqueClasses.forEach(className => {
            optionsHtml += `<option value="cadre-${className}">ç­å¹²éƒ¨ - ${className} ç­ (æ“ä½œ)</option>`;
        });
        
        optionsHtml += '<option value="student">å­¦ç”Ÿ (æŸ¥çœ‹)</option>';
        select.innerHTML = optionsHtml;
        
        // å°è¯•æ¢å¤ä¸Šæ¬¡çš„è§’è‰²é€‰æ‹©
        if (currentUserRole === 'cadre' && currentCadreClass) {
            select.value = `cadre-${currentCadreClass}`;
        } else {
            select.value = currentUserRole;
        }
    }

    function renderClassFilterOptions() {
        const select = document.getElementById('classFilter');
        select.innerHTML = '<option value="all">æ˜¾ç¤ºæ‰€æœ‰çŒäºº (All)</option>';

        const uniqueClasses = getUniqueClasses();
        uniqueClasses.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = `${className} ç­`;
            select.appendChild(option);
        });
        select.value = currentClassFilter;
    }

    function changeClassFilter(className) {
        currentClassFilter = className;
        renderHeroes();
    }

    function renderClassLeaderboard() {
        const container = document.getElementById('classLeaderboard');
        container.innerHTML = '';

        const classTotals = students.reduce((acc, s) => {
            acc[s.class] = (acc[s.class] || 0) + s.score;
            return acc;
        }, {});

        let classRankings = Object.keys(classTotals).map(className => ({
            name: `${className} ç­å…¬ä¼š`,
            score: parseFloat(classTotals[className].toFixed(1)),
            className: className
        }));
        classRankings.sort((a, b) => b.score - a.score);

        classRankings.forEach((c, index) => {
            const entry = document.createElement('div');
            entry.className = 'class-entry';
            entry.setAttribute('onclick', `showClassDetails('${c.className}')`);
            
            let rankIcon = `<span>#${index + 1}</span>`;
            if (index === 0) rankIcon = 'ğŸ¥‡';
            else if (index === 1) rankIcon = 'ğŸ¥ˆ';
            else if (index === 2) rankIcon = 'ğŸ¥‰';

            entry.innerHTML = `
                <div class="class-name">${rankIcon} ${c.name}</div>
                <div class="class-total-score">${c.score.toFixed(1)} ğŸ’°</div>
            `;
            container.appendChild(entry);
        });
    }
    
    function showClassDetails(className) {
        const modal = document.getElementById('classDetailModal');
        const overlay = document.getElementById('classDetailOverlay');
        const content = document.getElementById('classDetailContent');

        const studentsInClass = students
            .filter(s => s.class === className)
            .sort((a, b) => b.score - a.score);

        let listHtml = studentsInClass.map((s, index) => `
            <div style="display:flex; justify-content:space-between; align-items: center; padding:8px 0; border-bottom:1px dashed #444;">
                <span style="font-size: 16px;">${index + 1}. ${s.name}</span>
                <span style="color:var(--gold); font-weight:bold; font-size: 18px;">${s.score.toFixed(1)} ğŸ’°</span>
            </div>
        `).join('');

        content.innerHTML = `
            <h3 style="margin-top:0; color: var(--primary);">${className} ç­çŒäººæ¦œ (ä¸ªäººé‡‘å¸)</h3>
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                ${listHtml || '<p style="color:#aaa;">è¯¥ç­çº§æš‚æ— å­¦ç”Ÿæ•°æ®ã€‚</p>'}
            </div>
            <div style="text-align: right;">
                <button class="btn-secondary" onclick="closeClassDetails()">å…³é—­</button>
            </div>
        `;

        overlay.style.display = 'block';
        modal.style.display = 'block'; 
    }

    function closeClassDetails() {
        document.getElementById('classDetailOverlay').style.display = 'none';
        document.getElementById('classDetailModal').style.display = 'none';
    }


    function renderHeroes() {
        const grid = document.getElementById('heroGrid');
        const classFilter = document.getElementById('classFilter');
        grid.innerHTML = '';
        
        let filteredStudents = students;
        
        // V3.3: å¦‚æœæ˜¯ç­å¹²éƒ¨ï¼Œåªæ˜¾ç¤ºè‡ªå·±ç­çº§çš„å­¦ç”Ÿ
        if (currentUserRole === 'cadre' && currentCadreClass) {
            filteredStudents = students.filter(s => s.class === currentCadreClass);
            classFilter.style.display = 'none'; 
        } else {
            // æ•™å¸ˆ/å­¦ç”Ÿæ¨¡å¼ä¸‹çš„ç­›é€‰é€»è¾‘
            if (currentClassFilter !== 'all') {
                filteredStudents = students.filter(s => s.class === currentClassFilter);
            }
            classFilter.style.display = 'inline-block';
        }

        filteredStudents.sort((a, b) => b.score - a.score);

        filteredStudents.forEach((s, index) => {
            let title = s.score >= 0 ? "èµé‡‘çŒäºº" : "å€ºåŠ¡ç¼ èº«è€…";
            if (s.score > 50) title = "é»„é‡‘èµé‡‘ç‹";
            else if (s.score < -10) title = "é€šç¼‰çŠ¯";

            const avatarUrl = `https://api.dicebear.com/7.x/adventurer/svg?seed=${s.name}`;

            const card = document.createElement('div');
            card.className = 'hero-card';
            card.innerHTML = `
                <div class="avatar"><img src="${avatarUrl}" alt="avatar"></div>
                <div class="hero-info">
                    <div class="hero-name">${s.name} <span style="font-size:12px; color:#aaa">#${index+1} (${s.class}ç­)</span></div>
                    <div class="hero-rank">${title}</div>
                    <div class="hero-score" id="score-${s.id}">${s.score.toFixed(1)} ğŸ’°</div>
                    <div class="action-btns" id="actions-${s.id}">
                    </div>
                </div>
            `;
            grid.appendChild(card);

            if (roleMap[currentUserRole].canOperateScore) {
                const canAdjust = (currentUserRole === 'teacher') || 
                                  (currentUserRole === 'cadre' && s.class === currentCadreClass);
                
                if (canAdjust) {
                    const actionBtn = document.createElement('button');
                    actionBtn.className = 'btn-primary btn-mini';
                    actionBtn.innerText = 'è°ƒæ•´èµé‡‘';
                    actionBtn.onclick = () => openAdjustModal(s.id);
                    document.getElementById(`actions-${s.id}`).appendChild(actionBtn);
                }
            }
        });
    }

    // --- 4. å¯¼å…¥åå• (å¯¼å…¥åè°ƒç”¨ saveData) ---
    function openImport() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");
        document.getElementById('importOverlay').style.display = 'block';
        document.getElementById('importModal').style.display = 'block'; 
    }
    
    function closeImport() {
        document.getElementById('importOverlay').style.display = 'none';
        document.getElementById('importModal').style.display = 'none';
    }

    function processImport() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");

        const input = document.getElementById('studentNamesInput').value;
        const lines = input.split(/[\n]/).map(line => line.trim()).filter(line => line);
        
        if (lines.length > 0) {
            const currentStudentsMap = new Map();
            students.forEach(s => currentStudentsMap.set(s.name, s)); 

            let addedCount = 0;
            let updatedCount = 0;

            lines.forEach((line, idx) => {
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t'); 
                } else {
                    parts = line.split(','); 
                }

                if (parts.length >= 2) {
                    const rawName = parts[0].trim();
                    const name = rawName.includes('èµé‡‘çŒäºº') ? rawName : `${rawName}`; 
                    const score = parseFloat(parts[1].trim());
                    const className = parts.length > 2 && parts[2].trim() ? parts[2].trim() : '1'; 
                    
                    if (name && !isNaN(score)) {
                        const scoreToAdd = parseFloat(score.toFixed(1));
                        const existingStudent = currentStudentsMap.get(name);

                        if (existingStudent) {
                            existingStudent.score = parseFloat((existingStudent.score + scoreToAdd).toFixed(1));
                            updatedCount++;
                            addLog(`**å¯¼å…¥å åŠ **ï¼š${name} å åŠ  ${scoreToAdd} é‡‘å¸ã€‚`, 'Import', name, scoreToAdd);
                        } else {
                            const pinyinInitials = getPinyinInitials(name);
                            const newStudent = {
                                id: Date.now() + idx,
                                name: name,
                                score: scoreToAdd,
                                class: className,
                                pinyinInitials: pinyinInitials,
                                searchKey: (name + pinyinInitials).toLowerCase()
                            };
                            students.push(newStudent);
                            currentStudentsMap.set(name, newStudent); 
                            addedCount++;
                            addLog(`**å¯¼å…¥æ–°å¢**ï¼š${name} åŠ å…¥åå•ï¼Œåˆå§‹é‡‘å¸ ${scoreToAdd}ã€‚`, 'Import', name, scoreToAdd);
                        }
                    } else {
                        addLog(`**è­¦å‘Š**ï¼šå¯¼å…¥è¡Œæ ¼å¼é”™è¯¯æˆ–é‡‘å¸å€¼æ— æ•ˆï¼š${line}`);
                    }
                }
            });
            
            recalculateSearchKeys();
            renderRoleSelector(); 
            renderClassFilterOptions(); 
            renderClassLeaderboard();   
            renderHeroes();
            closeImport();
            addLog(`**ç³»ç»Ÿ**ï¼šå¯¼å…¥å®Œæˆã€‚æ–°å¢ ${addedCount} äººï¼Œæ›´æ–° ${updatedCount} äººã€‚`);
            saveData(); 
        }
    }


    // --- 5. å…‘æ¢é€»è¾‘ (å…‘æ¢åè°ƒç”¨ saveData) ---

    function populateStudentSelectors() {
        const classSelector = document.getElementById('exchangeClassSelector');
        const studentSelector = document.getElementById('exchangeStudentSelector');
        let selectedClass = classSelector.value;

        if (classSelector.options.length === 0 || classSelector.options.length === 1 && classSelector.options[0].value === "") {
            const uniqueClasses = getUniqueClasses();
            classSelector.innerHTML = uniqueClasses.map(c => `<option value="${c}">${c} ç­</option>`).join('');
            classSelector.value = uniqueClasses.length > 0 ? uniqueClasses[0] : '';
            selectedClass = classSelector.value; 
        }

        studentSelector.innerHTML = '';
        if (selectedClass) {
            const studentsInClass = students.filter(s => s.class === selectedClass).sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
            
            if (studentsInClass.length === 0) {
                studentSelector.innerHTML = '<option value="">è¯¥ç­çº§æš‚æ— å­¦ç”Ÿ</option>';
                studentSelector.disabled = true;
            } else {
                studentSelector.innerHTML = studentsInClass.map(s => 
                    `<option value="${s.id}">${s.name} (${s.score.toFixed(1)} ğŸ’°)</option>`
                ).join('');
                studentSelector.disabled = false;
            }
        }
    }

    function openExchangeSelector(itemId, isRandom = false) {
        if (!isStoreOpen) {
            return alert("å…‘æ¢å•†åº—å°šæœªå¼€å¯ï¼");
        }
        
        currentExchangeItemId = itemId;
        isRandomExchange = isRandom;
        
        const modal = document.getElementById('exchangeSelectorModal');
        const title = document.getElementById('exchangeTitle');
        const costInfo = document.getElementById('exchangeCostInfo');
        
        if (isRandom) {
            title.innerText = "ğŸ° éšæœºæ‰­æ‰­ä¹å…‘æ¢";
            costInfo.innerHTML = `<span style="color:var(--danger);">æœ¬æ¬¡å…‘æ¢æ¶ˆè€— ${RANDOM_COST.toFixed(1)} ğŸ’°ã€‚</span> å…‘æ¢åéšæœºè·å¾— **ç‹¬ç«‹å¥–æ± ** å•†å“ï¼`;
        } else {
            const item = storeItems.find(i => i.id === itemId);
            if (!item) return;
            title.innerText = `ğŸ›’ å…‘æ¢å•†å“ï¼š${item.name}`;
            costInfo.innerHTML = `<span style="color:var(--danger);">æœ¬æ¬¡å…‘æ¢æ¶ˆè€— ${item.cost.toFixed(1)} ğŸ’°ã€‚</span>`;
        }
        
        populateStudentSelectors();

        document.getElementById('exchangeSelectorOverlay').style.display = 'block';
        modal.style.display = 'block'; 
    }

    function closeExchangeSelector() {
        document.getElementById('exchangeSelectorOverlay').style.display = 'none';
        document.getElementById('exchangeSelectorModal').style.display = 'none';
        currentExchangeItemId = null;
        isRandomExchange = false;
    }
    
    function confirmExchange() {
        const studentId = parseInt(document.getElementById('exchangeStudentSelector').value);
        const student = students.find(s => s.id === studentId);

        if (!student) return alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„å…‘æ¢å­¦ç”Ÿã€‚");

        let cost;
        let itemToGrant;
        let actionDescription;

        if (isRandomExchange) {
            cost = RANDOM_COST;
            actionDescription = "éšæœºæ‰­æ‰­ä¹";
            if (gachaPrizes.length === 0) {
                return alert("æ‰­è›‹å¥–æ± ä¸ºç©ºï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ å¥–å“ï¼");
            }
            const randomIndex = Math.floor(Math.random() * gachaPrizes.length);
            itemToGrant = gachaPrizes[randomIndex]; 
            
        } else {
            itemToGrant = storeItems.find(i => i.id === currentExchangeItemId);
            if (!itemToGrant) return alert("å•†å“ä¿¡æ¯é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
            cost = itemToGrant.cost;
            actionDescription = `å…‘æ¢ [${itemToGrant.name}]`;
        }
        
        if (student.score < cost) {
            return alert(`é‡‘å¸ä¸è¶³ï¼${student.name} åªæœ‰ ${student.score.toFixed(1)} ğŸ’°ï¼Œéœ€è¦ ${cost.toFixed(1)} ğŸ’°ã€‚`);
        }
        
        if(confirm(`[${student.name}] ç¡®å®šèŠ±è´¹ ${cost.toFixed(1)} ğŸ’° è¿›è¡Œ ${actionDescription} å—ï¼Ÿ`)) {
            
            student.score = parseFloat((student.score - cost).toFixed(1)); 
            
            playExchangeJingle();

            const operator = roleMap[currentUserRole].tag + (currentCadreClass ? ` (${currentCadreClass}ç­)` : '');
            const logDetail = isRandomExchange ? `éšæœºè·å¾— ${itemToGrant.name}` : itemToGrant.name;
            addLog(`**å…‘æ¢**ï¼š${student.name} è¿›è¡Œäº† ${actionDescription}ã€‚`, 'Redeem', student.name, -cost, logDetail, operator);

            renderClassLeaderboard(); 
            renderHeroes();
            closeExchangeSelector();
            
            if (isRandomExchange) {
                openGachaResultModal(student.name, itemToGrant);
            } else {
                alert(`å…‘æ¢æˆåŠŸï¼${itemToGrant.name} å·²å‘æ”¾ç»™ ${student.name}ï¼`);
            }
            
            saveData(); 
        }
    }
    
    function buyItem(itemId) {
        openExchangeSelector(itemId, false);
    }
    
    function openGachaResultModal(studentName, item) {
        const title = document.getElementById('gachaResultTitle');
        const animation = document.getElementById('gachaAnimation');
        const revealArea = document.getElementById('gachaRevealArea');
        const itemName = document.getElementById('gachaItemName');
        const itemDesc = document.getElementById('gachaItemDesc');
        const closeBtn = document.getElementById('gachaCloseBtn');

        title.innerText = `${studentName} æ­£åœ¨æŠ½å–ç¥ç§˜æ‰­è›‹...`;
        animation.style.display = 'inline-block';
        revealArea.style.display = 'none';
        closeBtn.style.display = 'none';

        document.getElementById('gachaResultOverlay').style.display = 'block';
        document.getElementById('gachaResultModal').style.display = 'block'; 

        setTimeout(() => {
            animation.style.display = 'none';
            
            title.innerText = `ğŸ‰ ${studentName} æ‰­è›‹æˆåŠŸï¼ğŸ‰`;
            
            itemName.innerText = item.name; 
            itemDesc.innerText = item.desc;
            
            revealArea.style.display = 'block';
            closeBtn.style.display = 'block';
            
        }, 2000); 
    }
    
    function closeGachaResultModal() {
        document.getElementById('gachaResultOverlay').style.display = 'none';
        document.getElementById('gachaResultModal').style.display = 'none';
    }


    // --- 6. ç§¯åˆ†è°ƒæ•´ä¸åˆ é™¤ (æ“ä½œåè°ƒç”¨ saveData) ---
    
    function openSearchAdjustModal() {
        if (!roleMap[currentUserRole].canOperateScore) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");
        
        if (currentUserRole === 'cadre' && !currentCadreClass) {
            return alert("ç­å¹²éƒ¨æœªæŒ‡å®šè´Ÿè´£ç­çº§ï¼Œè¯·é‡æ–°é€‰æ‹©è§’è‰²æˆ–è”ç³»æ•™å¸ˆã€‚");
        }
        
        document.getElementById('studentSearchInput').value = '';
        filterStudentsForAdjust(''); 
        
        const instruction = document.getElementById('searchInstruction');
        if (currentUserRole === 'cadre') {
            instruction.innerText = `ç‚¹å‡»åˆ—è¡¨ä¸­çš„ã€${currentCadreClass}ç­ã€‘çŒäººè¿›è¡Œèµé‡‘è°ƒæ•´ã€‚`;
        } else {
            instruction.innerText = 'ç‚¹å‡»åˆ—è¡¨ä¸­çš„çŒäººè¿›è¡Œèµé‡‘è°ƒæ•´ã€‚';
        }
        
        document.getElementById('searchAdjustOverlay').style.display = 'block';
        document.getElementById('searchAdjustModal').style.display = 'block'; 
    }

    function closeSearchAdjustModal() {
        document.getElementById('searchAdjustOverlay').style.display = 'none';
        document.getElementById('searchAdjustModal').style.display = 'none';
    }

    function filterStudentsForAdjust(query) {
        const resultsContainer = document.getElementById('studentSearchResults');
        const normalizedQuery = query.toLowerCase().trim();
        
        if (normalizedQuery.length === 0) {
            resultsContainer.innerHTML = '<p style="color:#aaa; text-align:center; padding:10px;">å¼€å§‹è¾“å…¥å§“åæˆ–é¦–å­—æ¯ï¼ˆä¾‹å¦‚ï¼šZSï¼‰...</p>';
            return;
        }

        let studentsToSearch = students;
        if (currentUserRole === 'cadre' && currentCadreClass) {
            studentsToSearch = students.filter(s => s.class === currentCadreClass);
        }

        const filtered = studentsToSearch.filter(s => {
            return s.searchKey.includes(normalizedQuery);
        });

        if (filtered.length === 0) {
            resultsContainer.innerHTML = '<p style="color:#e74c3c; text-align:center; padding:10px;">æœªæ‰¾åˆ°åŒ¹é…çš„çŒäººã€‚</p>';
        } else {
            resultsContainer.innerHTML = filtered.map(s => `
                <div class="search-result-item" onclick="selectStudentForAdjust(${s.id})">
                    <span>${s.name} (${s.class}ç­)</span>
                    <span style="color:var(--gold);">${s.score.toFixed(1)} ğŸ’°</span>
                </div>
            `).join('');
        }
    }
    
    function selectStudentForAdjust(id) {
        closeSearchAdjustModal();
        openAdjustModal(id);
    }


    function openAdjustModal(id) {
        const student = students.find(s => s.id === id);
        if (!student) return alert("å­¦ç”Ÿä¸å­˜åœ¨ã€‚");
        
        if (currentUserRole === 'cadre' && student.class !== currentCadreClass) {
            return alert(`æƒé™ä¸è¶³ï¼šæ‚¨æ˜¯ ${currentCadreClass} ç­å¹²éƒ¨ï¼Œæ— æ³•æ“ä½œ ${student.class} ç­å­¦ç”Ÿã€‚`);
        }
        
        adjustingStudentId = id;
        document.getElementById('adjustTitle').innerText = `è°ƒæ•´èµé‡‘ï¼š${student.name}`;
        document.getElementById('adjustAmount').value = '';
        document.getElementById('adjustReason').value = '';
        
        const deleteButton = document.getElementById('deleteStudentBtn');
        if (deleteButton) {
            deleteButton.style.display = roleMap[currentUserRole].canAdmin ? 'inline-block' : 'none';
        }

        document.getElementById('adjustOverlay').style.display = 'block';
        document.getElementById('adjustModal').style.display = 'block'; 
    }

    function submitAdjust() {
        const id = adjustingStudentId;
        const student = students.find(s => s.id === id);

        if (!student) return alert("å­¦ç”Ÿä¸å­˜åœ¨ã€‚");

        if (currentUserRole === 'cadre' && student.class !== currentCadreClass) {
            alert(`æƒé™ä¸è¶³ï¼šæ‚¨æ˜¯ ${currentCadreClass} ç­å¹²éƒ¨ï¼Œæ— æ³•æ“ä½œ ${student.class} ç­å­¦ç”Ÿã€‚`);
            closeAdjustModal();
            return;
        }

        const amount = parseFloat(document.getElementById('adjustAmount').value);
        const reason = document.getElementById('adjustReason').value.trim();

        if (isNaN(amount) || amount === 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘å¸å€¼ (é0)");
            return;
        }
        if (reason.length < 2) {
            alert("è¯·è¾“å…¥æ“ä½œåŸå› ï¼");
            return;
        }
        
        student.score = parseFloat((student.score + amount).toFixed(1));

        const operatorRoleTag = roleMap[currentUserRole].tag;
        const operatorTag = operatorRoleTag + (currentCadreClass ? ` (${currentCadreClass}ç­)` : '');

        const action = amount > 0 ? "è·å¾—" : "å¤±å»";
        
        addLog(`**${student.name}** ${action} ${Math.abs(amount).toFixed(1)} é‡‘å¸ã€‚åŸå› : ${reason}`, 'Adjust', student.name, amount, reason, operatorTag);

        renderClassLeaderboard(); 
        renderHeroes();
        closeAdjustModal();
        saveData(); 
    }
    
    function clearAllScores() {
        if (!roleMap[currentUserRole].canAdmin) {
            return alert("åªæœ‰æ•™å¸ˆ (ç®¡ç†) æ‰èƒ½æ¸…é›¶æ‰€æœ‰ç§¯åˆ†ã€‚");
        }

        if (confirm("âš ï¸ æåº¦è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦å°†**æ‰€æœ‰**å­¦ç”Ÿçš„é‡‘å¸æ¸…é›¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
            if (prompt("è¯·å†æ¬¡è¾“å…¥ 'æ¸…é›¶' (ä¸­æ–‡) ä»¥ç¡®è®¤æ“ä½œï¼š") === 'æ¸…é›¶') {
                const operatorTag = roleMap[currentUserRole].tag;
                
                students.forEach(s => {
                    if (s.score !== 0) {
                        const amount = -s.score;
                        s.score = 0.0;
                        addLog(`**æ¸…é›¶**ï¼š${s.name} ç§¯åˆ†è¢«æ¸…é›¶ã€‚`, 'ClearScore', s.name, amount, 'æ•™å¸ˆæ“ä½œï¼šç§¯åˆ†å‘¨æœŸæ¸…é›¶', operatorTag);
                    }
                });

                renderClassLeaderboard(); 
                renderHeroes();
                saveData(); 
                alert("âœ… æ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†å·²æˆåŠŸæ¸…é›¶ï¼");
            } else {
                alert("ç¡®è®¤å¤±è´¥ï¼Œç§¯åˆ†æ¸…é›¶æ“ä½œå·²å–æ¶ˆã€‚");
            }
        }
    }

    function deleteStudent(id) {
        if (!roleMap[currentUserRole].canAdmin) {
            alert("åªæœ‰æ•™å¸ˆ (ç®¡ç†) æ‰èƒ½åˆ é™¤å­¦ç”Ÿã€‚");
            return;
        }

        const studentIndex = students.findIndex(s => s.id === id);
        if (studentIndex !== -1) {
            const studentName = students[studentIndex].name;
            if (confirm(`âš ï¸ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤å­¦ç”Ÿ [${studentName}] åŠå…¶æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) {
                students.splice(studentIndex, 1);
                
                const operatorTag = roleMap[currentUserRole].tag;
                addLog(`**åˆ é™¤**ï¼šæ•™å¸ˆåˆ é™¤äº†å­¦ç”Ÿ [${studentName}]ã€‚`, 'Delete', studentName, 0, 'æ°¸ä¹…ç§»é™¤', operatorTag);
                
                recalculateSearchKeys();
                renderRoleSelector(); 
                renderClassFilterOptions(); 
                renderClassLeaderboard(); 
                renderHeroes();
                closeAdjustModal();
                alert(`å­¦ç”Ÿ ${studentName} å·²è¢«æˆåŠŸç§»é™¤ã€‚`);
                
                saveData(); 
            }
        }
    }

    function closeAdjustModal() {
        document.getElementById('adjustOverlay').style.display = 'none';
        document.getElementById('adjustModal').style.display = 'none';
        adjustingStudentId = null;
    }


    // --- 7. å•†åº—ç®¡ç†è¾…åŠ©å‡½æ•° (å•†åº—æ“ä½œåè°ƒç”¨ saveData) ---
    
    function renderStore() {
        const container = document.getElementById('storeItemsContainer');
        const listManager = document.getElementById('currentStoreList');
        const gachaListManager = document.getElementById('currentGachaList'); 
        
        container.innerHTML = '';
        listManager.innerHTML = '';
        gachaListManager.innerHTML = '';
        
        storeItems.forEach(item => {
            const itemCard = document.createElement('div');
            itemCard.className = 'item-card';
            itemCard.innerHTML = `
                <div>
                    <div style="font-weight:bold">${item.name}</div>
                    <div style="font-size:12px; color:#aaa">${item.desc}</div>
                </div>
                <button class="btn-gold btn-mini" onclick="buyItem(${item.id})">${item.cost.toFixed(1)} ğŸ’°</button>
            `;
            container.appendChild(itemCard);
        });

        storeItems.forEach(item => {
            const managerEntry = document.createElement('div');
            managerEntry.className = 'item-card';
            managerEntry.style.backgroundColor = 'rgba(255,255,255,0.1)';
            managerEntry.innerHTML = `
                <span>${item.name} (${item.cost.toFixed(1)} ğŸ’°)</span>
                <button class="btn-danger btn-mini" onclick="deleteItemFromStore(${item.id})">åˆ é™¤</button>
            `;
            listManager.appendChild(managerEntry);
        });
        
        gachaPrizes.forEach(item => {
            const managerEntry = document.createElement('div');
            managerEntry.className = 'item-card';
            managerEntry.style.backgroundColor = 'rgba(27, 42, 63, 0.5)';
            managerEntry.style.borderLeft = '4px solid var(--gold)';
            managerEntry.innerHTML = `
                <span>${item.name} <span style="font-size:12px; color:#aaa">(${item.desc})</span></span>
                <button class="btn-danger btn-mini" onclick="deleteItemFromGachaPool(${item.id})">åˆ é™¤</button>
            `;
            gachaListManager.appendChild(managerEntry);
        });
    }

    function openStoreManager() {
        if (!roleMap[currentUserRole].canAdmin) return alert("åªæœ‰æ•™å¸ˆæ‰èƒ½ç®¡ç†å•†åº—å•†å“ã€‚");
        renderStore();
        document.getElementById('storeManagerOverlay').style.display = 'block';
        document.getElementById('storeManagerModal').style.display = 'block'; 
    }

    function closeStoreManager() {
        document.getElementById('storeManagerOverlay').style.display = 'none';
        document.getElementById('storeManagerModal').style.display = 'none';
    }

    function addItemToStore() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");

        const name = document.getElementById('newItemName').value.trim();
        const cost = parseFloat(document.getElementById('newItemCost').value);
        const desc = document.getElementById('newItemDesc').value.trim();

        if (!name || isNaN(cost) || cost <= 0) {
            return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å•†å“åç§°å’Œé‡‘å¸æ•°ã€‚");
        }
        
        const newItem = {
            id: Date.now(),
            name: name,
            cost: parseFloat(cost.toFixed(1)),
            desc: desc || 'æ— æè¿°'
        };

        storeItems.push(newItem);
        document.getElementById('newItemName').value = '';
        document.getElementById('newItemCost').value = '';
        document.getElementById('newItemDesc').value = '';
        
        renderStore();
        addLog(`**å•†åº—**ï¼šæˆåŠŸæ·»åŠ å¸¸è§„å•†å“ [${name}] (${cost} ğŸ’°)`, 'Store');
        saveData(); 
    }

    function deleteItemFromStore(itemId) {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");
        
        if(confirm("ç¡®å®šè¦åˆ é™¤æ­¤å¸¸è§„å•†å“å—ï¼Ÿ")) {
            const index = storeItems.findIndex(item => item.id === itemId);
            if (index !== -1) {
                const deletedName = storeItems[index].name;
                storeItems.splice(index, 1);
                renderStore();
                addLog(`**å•†åº—**ï¼šå·²åˆ é™¤å¸¸è§„å•†å“ [${deletedName}]`, 'Store');
                saveData(); 
            }
        }
    }

    function addItemToGachaPool() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");

        const name = document.getElementById('newGachaName').value.trim();
        const desc = document.getElementById('newGachaDesc').value.trim();

        if (!name) {
            return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰­è›‹å¥–å“åç§°ã€‚");
        }
        
        const newPrize = {
            id: Date.now() + 10000, 
            name: name,
            desc: desc || 'æ— æè¿°'
        };

        gachaPrizes.push(newPrize);
        document.getElementById('newGachaName').value = '';
        document.getElementById('newGachaDesc').value = '';
        
        renderStore();
        addLog(`**æ‰­è›‹**ï¼šæˆåŠŸæ·»åŠ å¥–å“ [${name}]`, 'Gacha');
        saveData(); 
    }

    function deleteItemFromGachaPool(itemId) {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");
        
        if(confirm("ç¡®å®šè¦åˆ é™¤æ­¤æ‰­è›‹å¥–å“å—ï¼Ÿ")) {
            const index = gachaPrizes.findIndex(item => item.id === itemId);
            if (index !== -1) {
                const deletedName = gachaPrizes[index].name;
                gachaPrizes.splice(index, 1);
                renderStore();
                addLog(`**æ‰­è›‹**ï¼šå·²åˆ é™¤å¥–å“ [${deletedName}]`, 'Gacha');
                saveData(); 
            }
        }
    }
    
    function toggleStore(shouldSave = true) {
        if (shouldSave && !roleMap[currentUserRole].canAdmin) return alert("åªæœ‰æ•™å¸ˆå…·æœ‰å¼€å¯/å…³é—­å…‘æ¢å•†åº—çš„æƒé™ã€‚");
        
        if (shouldSave) {
            isStoreOpen = !isStoreOpen;
        } 

        const btn = document.getElementById('toggleStoreBtn');
        const badge = document.getElementById('storeStatusBadge');
        const container = document.getElementById('storeItemsContainer');
        const randomBtn = document.getElementById('randomExchangeBtn');

        if (isStoreOpen) {
            btn.innerText = "ğŸ”’ ç»“æŸå…‘æ¢";
            btn.className = "btn-danger";
            badge.innerText = "è¥ä¸šä¸­";
            badge.className = "store-status status-open";
            container.style.opacity = "1";
            container.style.pointerEvents = "auto";
            randomBtn.style.display = "block";
            if (shouldSave) addLog(`**å•†åº—**ï¼šå…‘æ¢å•†åº—å·²å¼€å¯`, 'Store');
        } else {
            btn.innerText = "ğŸ”“ å¼€å¯å…‘æ¢";
            btn.className = "btn-primary";
            badge.innerText = "ä¼‘æ¯ä¸­";
            badge.className = "store-status status-closed";
            container.style.opacity = "0.5";
            container.style.pointerEvents = "none";
            randomBtn.style.display = "none";
            if (shouldSave) addLog(`**å•†åº—**ï¼šå…‘æ¢å•†åº—å·²å…³é—­`, 'Store');
        }

        if (shouldSave) saveData(); 
    }
    
    // --- 8. Pinyin æ˜ å°„ç®¡ç† (æ“ä½œåè°ƒç”¨ saveData) ---

    function openPinyinManager() {
        if (!roleMap[currentUserRole].canAdmin) return alert("åªæœ‰æ•™å¸ˆæ‰èƒ½ç®¡ç†æ‹¼éŸ³æ˜ å°„ã€‚");
        closeStoreManager();
        renderPinyinMap();
        document.getElementById('pinyinManagerOverlay').style.display = 'block';
        document.getElementById('pinyinManagerModal').style.display = 'block'; 
    }

    function closePinyinManager() {
        document.getElementById('pinyinManagerOverlay').style.display = 'none';
        document.getElementById('pinyinManagerModal').style.display = 'none';
        openStoreManager();
    }

    function renderPinyinMap() {
        const container = document.getElementById('currentPinyinList');
        container.innerHTML = '';

        const sortedKeys = Object.keys(PinyinMap).filter(k => k !== 'Â·').sort((a, b) => a.localeCompare(b, 'zh-CN'));
        
        if (sortedKeys.length === 0) {
            container.innerHTML = '<p style="color:#aaa; text-align:center; padding:10px;">æš‚æ— è‡ªå®šä¹‰æ˜ å°„ã€‚</p>';
            return;
        }

        sortedKeys.forEach(char => {
            const initial = PinyinMap[char];
            const entry = document.createElement('div');
            entry.className = 'pinyin-entry';
            entry.innerHTML = `
                <div>
                    <span class="pinyin-char">${char}</span> æ˜ å°„åˆ° 
                    <span class="pinyin-initial">${initial}</span>
                </div>
                <button class="btn-danger btn-mini" onclick="deletePinyinMapping('${char}')">åˆ é™¤</button>
            `;
            container.appendChild(entry);
        });
    }

    function addPinyinMapping() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");

        let char = document.getElementById('newPinyinChar').value.trim();
        let initial = document.getElementById('newPinyinInitial').value.trim().toUpperCase();

        if (char.length !== 1 || !char.match(/[\u4e00-\u9fa5]/g)) {
            return alert("æ±‰å­—è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥ä¸€ä¸ªæ±‰å­—ã€‚");
        }
        if (initial.length !== 1 || !initial.match(/[A-Z]/g)) {
            return alert("é¦–å­—æ¯è¾“å…¥æ— æ•ˆï¼Œè¯·è¾“å…¥ä¸€ä¸ªå¤§å†™å­—æ¯ (A-Z)ã€‚");
        }

        if (PinyinMap[char]) {
            if (!confirm(`æ±‰å­—ã€${char}ã€‘å·²å­˜åœ¨æ˜ å°„ã€${PinyinMap[char]}ã€‘ï¼Œæ˜¯å¦è¦†ç›–ä¸ºã€${initial}ã€‘ï¼Ÿ`)) {
                return;
            }
        }

        PinyinMap[char] = initial;

        document.getElementById('newPinyinChar').value = '';
        document.getElementById('newPinyinInitial').value = '';

        recalculateSearchKeys();
        renderPinyinMap();
        addLog(`**æ‹¼éŸ³æ˜ å°„**ï¼šæ·»åŠ /æ›´æ–°æ±‰å­—ã€${char}ã€‘åˆ°ã€${initial}ã€‘`, 'Pinyin');
        saveData(); 
    }

    function deletePinyinMapping(char) {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");

        if (confirm(`ç¡®å®šè¦åˆ é™¤æ±‰å­—ã€${char}ã€‘çš„æ‹¼éŸ³æ˜ å°„å—ï¼Ÿ`)) {
            if (PinyinMap[char]) {
                delete PinyinMap[char];
                
                recalculateSearchKeys();
                renderPinyinMap();
                addLog(`**æ‹¼éŸ³æ˜ å°„**ï¼šåˆ é™¤æ±‰å­—ã€${char}ã€‘çš„æ˜ å°„`, 'Pinyin');
                saveData(); 
            }
        }
    }
    
    // --- 9. æ—¥å¿—ä¸å¯¼å‡ºè¾…åŠ©å‡½æ•° ---
    
    function changeRole(value) {
        if (value.startsWith('cadre-')) {
            currentUserRole = 'cadre';
            currentCadreClass = value.split('-')[1];
        } else {
            currentUserRole = value;
            currentCadreClass = null;
        }

        const roleInfo = roleMap[currentUserRole];
        
        const roleTag = document.getElementById('roleTag');
        const tagText = roleInfo.tag + (currentCadreClass ? ` (${currentCadreClass}ç­)` : '');
        
        roleTag.innerText = tagText;
        roleTag.className = `role-tag ${roleInfo.class}`;

        document.getElementById('importBtn').style.display = roleInfo.canAdmin ? 'block' : 'none';
        document.getElementById('manageStoreBtn').style.display = roleInfo.canAdmin ? 'block' : 'none';
        document.getElementById('exportLogBtn').style.display = roleInfo.canAdmin ? 'block' : 'none';
        
        // ä»…ä¿ç•™å¯¼å‡ºCSVæŒ‰é’®
        document.getElementById('exportCSVBtn').style.display = roleInfo.canAdmin ? 'block' : 'none';
        
        document.getElementById('clearScoreBtn').style.display = roleInfo.canAdmin ? 'block' : 'none'; 
        
        document.getElementById('toggleStoreBtn').style.display = roleInfo.canAdmin ? 'block' : 'none';
        
        document.getElementById('searchAdjustBtn').style.display = roleInfo.canOperateScore ? 'block' : 'none';
        
        if (currentUserRole === 'cadre' && currentCadreClass) {
            currentClassFilter = currentCadreClass;
        } else {
            if (currentClassFilter !== 'all' && currentUserRole !== 'cadre') {
                 const filterSelect = document.getElementById('classFilter');
                 if (!getUniqueClasses().includes(currentClassFilter)) {
                     currentClassFilter = 'all';
                 }
                 filterSelect.value = currentClassFilter;
            }
        }

        renderHeroes();
        addLog(`**ç³»ç»Ÿ**ï¼šè§’è‰²å·²åˆ‡æ¢ä¸º [${tagText}]`, 'System');
    }

    function playExchangeJingle() {
        const audio = document.getElementById('exchangeJingle');
        if (audio) {
            if (audio.src === "") {
                console.warn("æœªè®¾ç½®æœ‰æ•ˆçš„å…‘æ¢éŸ³æ•ˆé“¾æ¥ï¼Œæ— æ³•æ’­æ”¾ã€‚");
                return;
            }
            audio.currentTime = 0;
            audio.play().catch(error => {
                console.error("æ— æ³•æ’­æ”¾éŸ³æ•ˆï¼Œéœ€è¦ç”¨æˆ·äº¤äº’æˆ–æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§ã€‚", error);
            });
        }
    }
    
    function addLog(text, type = 'System', name = '', amount = 0, detail = '', operator = '') {
        const timestamp = new Date().toLocaleString();
        
        exchangeLog.push({
            timestamp: timestamp,
            type: type,
            name: name,
            amount: amount.toFixed(1),
            detail: detail,
            operator: operator
        });

        const logArea = document.getElementById('logArea');
        if (logArea) {
             const entry = document.createElement('div');
             entry.innerHTML = `[${timestamp.split(' ')[1]}] ${text}`;
             logArea.prepend(entry);
        }

        if (exchangeLog.length > 500) {
            exchangeLog.shift(); 
        }
    }
    
    function renderLogHistory() {
        const logArea = document.getElementById('logArea');
        logArea.innerHTML = '';
        for (let i = exchangeLog.length - 1; i >= 0; i--) {
            const log = exchangeLog[i];
            const entry = document.createElement('div');
            let logText = log.detail;
            if (log.type === 'Adjust' || log.type === 'ClearScore') {
                const action = parseFloat(log.amount) > 0 ? "è·å¾—" : "å¤±å»";
                const amountText = parseFloat(log.amount) === 0.0 ? "æ‰€æœ‰é‡‘å¸" : `${Math.abs(parseFloat(log.amount)).toFixed(1)} é‡‘å¸`;
                logText = `**${log.name}** ${action} ${amountText}ã€‚åŸå› : ${log.detail}`;
            } else if (log.type === 'Redeem') {
                 logText = log.detail;
            } else if (log.type === 'Delete') {
                 logText = log.detail;
            }
            
            entry.innerHTML = `[${log.timestamp.split(' ')[1]}] ${logText}`;
            logArea.appendChild(entry);
        }
        if (exchangeLog.length === 0) {
            logArea.innerHTML = 'æš‚æ— è®°å½•...';
        }
    }


    function exportLogData() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");
        if (exchangeLog.length === 0) return alert("æš‚æ— æ“ä½œæ—¥å¿—å¯å¯¼å‡ºã€‚");

        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        csvContent += "æ—¶é—´,æ“ä½œç±»å‹,å­¦ç”Ÿå§“å,é‡‘å¸å˜åŠ¨,è¯¦æƒ…/åŸå› ,æ“ä½œäºº\n";
        
        exchangeLog.forEach(log => {
            const detail = log.detail.replace(/,/g, 'ï¼Œ'); 
            const row = `${log.timestamp},${log.type},${log.name},${log.amount},"${detail}",${log.operator}\n`;
            csvContent += row;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "èµé‡‘çŒäºº_æ“ä½œæ—¥å¿—.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addLog(`**ç³»ç»Ÿ**ï¼šæ“ä½œæ—¥å¿—å·²æˆåŠŸå¯¼å‡º (${exchangeLog.length} æ¡è®°å½•)ã€‚`, 'System');
    }

    function exportData() {
        if (!roleMap[currentUserRole].canAdmin) return alert("æ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œã€‚");
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        csvContent += "æ’å,ID,å§“å,é‡‘å¸å€¼,ç­çº§\n";
        
        students.sort((a, b) => b.score - a.score); 

        students.forEach((s, index) => {
            csvContent += `${index+1},${s.id},${s.name},${s.score.toFixed(1)},${s.class}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "èµé‡‘çŒäººæ¦œ_æˆ˜æŠ¥.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addLog(`**ç³»ç»Ÿ**ï¼šæˆ˜æŠ¥æ•°æ®å·²æˆåŠŸå¯¼å‡ºã€‚`, 'System');
    }

    // å¯åŠ¨
    init();

</script>

</body>
</html>